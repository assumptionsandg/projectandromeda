<!DOCTYPE html>
<link rel='stylesheet' type='text/css' href='simstyle.css'>
<h1>Project Andromeda</h1>

<div class='vertibox' style='position:absolute;'>
    <p>Version 0.03 Slightly Less Oof Build</p>
    <button id='myBtn'>Add New Planet</button>

    <div id='myModal' class='modal'>

    <div class='modal-content'>
        <div class='modal-body'>
            <span class='close'>&times;</span>
            <p>Add New Planet Menu:</p>
            <select id='selectpreset'>
                <option>Planet</option>
                <option>Mercury</option>
                <option>Venus</option>
                <option>Earth</option>
                <option>Mars</option>
                <option>Jupiter</option>
                <option>Saturn</option>
                <option>Uranus</option>
                <option>Neptune</option>
                <option>Pluto</option>
            </select>
            <input type='text' id='massvalue' name='massvalue' placeholder='Enter Mass Value'></input>
            <input type='text' id='rot' placeholder='Enter Rotation'></input>
            <input type='text' id='xpos' placeholder='Enter X Position'></input>
            <input type='text' id='ypos' placeholder='Enter Y Position'></input>
            <input type='text' id='zpos' placeholder='Enter Z Position'></input>
            <input type='text' id='vxval' placeholder='Enter X Velocity'></input>
            <input type='text' id='vyval' placeholder='Enter Y Velocity'></input>
            <input type='text' id='vzval' placeholder='Enter Z Velocity'></input>
        </div>
        <div class='modal-footer'>
            <a id='newMod'>Add Planet</a>
        </div>
    </div>

    </div>
    <button>Add New Star</button>
</div>
<div class='infobox' style='position:absolute;'>
    <select id='changeplanet'></select>
    <p>X Position: <span id='xposhtml'></span></p>
    <p>Y Position: <span id='yposhtml'></span></p>
    <p>Z Position: <span id='zposhtml'></span></p>
    <p>X Velocity: <span id='xvelhtml'></span></p>
    <p>Y Velocity: <span id='yvelhtml'></span></p>
    <p>Z Velocity: <span id='zvelhtml'></span></p>
</div>

<body style='margin: 0px; background-color: #000000; overflow: hidden';>
    <script type='module'>

        import * as THREE from '/three.module.js'

        let allupdate = []
        let allmass = []
        let allplanets = []
        let allcount = [] 
        let planetmass = []
        let planetx = []
        let planety = []
        let planetz = []
        let planetvx = []
        let planetvy = []
        let planetvz = []

        let allx = []
        let ally = []
        let allz = []
        let count=0
        let pcount=0
        
        allmass.fill(0)
        allplanets.fill(0)
        allx.fill(0)
        ally.fill(0)
        allz.fill(0)
        planetx.fill(0)

        class Star{
            constructor(mass,rotation,x,y,z,vx,vy,vz){
                this.mass=mass
                this.rotation=rotation
                this.x=x
                this.y=y
                this.z=z
                this.vx=vx
                this.vy=vy
                this.vz=vz
             
                this.draw()
                this.update()
            }

            draw(){
                let self = this
                count=count+1
                this.geometry = new THREE.SphereGeometry(0.5,32,32)
                this.material = new THREE.MeshPhongMaterial({
                    map:THREE.ImageUtils.loadTexture('images/sunmap.jpg')
                })
                this.mesh = new THREE.Mesh(this.geometry,this.material)
                // console.log(this.x)
                this.mesh.position.x=this.x
                this.mesh.position.y=this.y
                this.mesh.position.z=this.z
                allmass.push(this.mass)
                allmass.unshift(this.mass)
                allmass.pop()
                // console.log(this.mesh.position.x)
                // console.log(allmass)
            }

            update(){
                let self = this
                let resultantAx=0
                let resultantAy=0
                let resultantAz=0
                allx.push(self.x)
                ally.push(self.y)
                allz.push(self.z)
                allplanets.push(count)
                allplanets.push(0)

                allupdate.push(function(delta){
                    self.mesh.rotation.x += 1/2 * delta;
                    allx.unshift(self.x)
                    ally.unshift(self.y)
                    allz.unshift(self.z)
                    allx.pop()
                    ally.pop()
                    allz.pop()
                    self.mesh.position.x+=self.vx
                    self.mesh.position.y+=self.vy
                    self.mesh.position.z+=self.vz
                })
            }

            getMesh(){
                return this.mesh
            }


        }

        class Sun extends Star{

        }

        class Planet{
            constructor(mass,x,y,z,vx,vy,vz){
                this.mass=mass
                this.x=x
                this.y=y
                this.z=z
                this.vx=vx
                this.vy=vy
                this.vz=vz
                this.draw()
                this.update()
                pcount+=1
                let select, option;

                select = document.getElementById( 'changeplanet' );
                    
                option = document.createElement( 'option' );
                option.value = option.text = 'Earth';
                select.add( option );
                
                
            }

            draw(){
                let self = this
                this.geometry = new THREE.SphereGeometry(0.5,32,32)
                this.material = new THREE.MeshPhongMaterial({
                    map:self.texture,
                    bumpMap:self.bump,
                    bumpscale:this.bumpscale,
                    specularMap:this.speccmap,
                    specular:this.spec,
                    tansparent:this.transparenty,
                    opacity:this.opacitie,
                    side:this.sidey
                })
                this.mesh = new THREE.Mesh(this.geometry,this.material)
                this.mesh.position.x=this.x
                this.mesh.position.y=this.y
                this.mesh.position.z=this.z
                
            }

            update(){
                let self = this
                let ax=0
                let ay=0
                let az=0
                let rAx=0
                let rAy=0
                let rAz=0
                let radii=0
                let gravConst=6.67e-11
               
                allupdate.push(function(delta){
                for(let i=2; i>-1; i--){
                    if(allz[i]>self.mesh.position.z || ally[i]>self.mesh.position.y || allx[i]>self.mesh.position.x || allplanets[1]==0){
                        radii=Math.sqrt(((self.mesh.position.x-allx[i])**2)+((self.mesh.position.y-ally[i])**2)+((self.mesh.position.z-allz[i])**2))
                    }
                    else{
                        radii=-Math.sqrt(((self.mesh.position.x-allx[i])**2)+((self.mesh.position.y-ally[i])**2)+((self.mesh.position.z-allz[i])**2))
                    }
                    ax=-(gravConst*(allmass[i])*self.mesh.position.x)/radii**3
                    ay=-(gravConst*(allmass[i])*self.mesh.position.y)/radii**3
                    az=-(gravConst*(allmass[i])*self.mesh.position.z)/radii**3
                    ax=ax*10000000
                    ay=ay*10000000
                    az=az*10000000
                    rAx+=ax
                    rAy+=ay
                    rAz+=az
                    // console.log(self.mesh.position.x)
                    // console.log(self.mesh.position.y)
                    // console.log(self.mesh.position.z)

                } 
                    self.mesh.rotation.y += 1/2 * delta;
                    self.vx+=ax
                    self.vy+=ay
                    self.vz+=az
                    self.mesh.position.x+=self.vx
                    self.mesh.position.y+=self.vy
                    self.mesh.position.z+=self.vz
                    document.getElementById('xposhtml').innerHTML=self.mesh.position.x
                    document.getElementById('yposhtml').innerHTML=self.mesh.position.y
                    document.getElementById('zposhtml').innerHTML=self.mesh.position.z
                    document.getElementById('xvelhtml').innerHTML=self.vx
                    document.getElementById('yvelhtml').innerHTML=self.vy
                    document.getElementById('zvelhtml').innerHTML=self.vz

                })
                
            }

            getMesh(){
                return this.mesh
            }

        }

        class Mercury extends Planet{
            constructor(mass,x,y,z,vx,vy,vz){
                super(mass,x,y,z,vx,vy,vz)
                this.texture=THREE.ImageUtils.loadTexture('images/mercurymap.jpg')
                this.bump=THREE.ImageUtils.loadTexture('images/mercurybump.jpg')
                this.bumpscale=0.005
                this.draw()
                this.update()
            }
        }

        class Venus extends Planet{
            constructor(mass,x,y,z,vx,vy,vz){
                super(mass,x,y,z,vx,vy,vz)
                let self = this
                this.texture=THREE.ImageUtils.loadTexture('images/venusmap.jpg')
                self.bump=THREE.ImageUtils.loadTexture('images/venusbump.jpg')
                this.bumpscale=0.005
                this.draw()
                this.update()
            }
        }

        class Earth extends Planet{
            constructor(mass,x,y,z,vx,vy,vz){
                super(mass,x,y,z,vx,vy,vz)
                this.texture=THREE.ImageUtils.loadTexture('images/earthmap1k.jpg')
                this.bump=THREE.ImageUtils.loadTexture('images/earthbump1k.jpg')
                this.bumpscale=0.05
                this.speccmap=THREE.ImageUtils.loadTexture('images/earthspec1k.jpg')
                this.spec=new THREE.Color('grey')
                this.draw()
                this.update()
            }
        }
        
        class EarthCloud extends Planet{
            constructor(mass,x,y,z,vx,vy,vz){
                super(mass,x,y,z,vx,vy,vz)
                let self=this
                
                self.canvasResult=document.createElement('canvas')
                self.canvasResult.width=1024
                self.canvasResult.height=512

                self.imageMap=new Image()
                self.imageMap.addEventListener('load', function(){
                    self.canvasMap=document.createElement('canvas')
                    self.canvasMap.width=self.imageMap.width
                    self.canvasMap.height=self.imageMap.height
                    self.contextMap=self.canvasMap.getContext('2d')
                    self.contextMap.drawImage(self.imagemap,0,0)
                    self.dataMap=contextMap.getImageData(0,0,self.canvasMap.width,self.canvasMap.height)
                    
                    self.imageTrans=new Image()
                    self.imageTrans.addEventListener('load', function(){
                        self.canvasTrans=docuemnt.createElement('canvas')
                        self.canvasTrans.width=self.imageTrans.width
                        self.canvasTrans.height=self.imageTrans.height
                        self.contextTrans=self.canvasTrans.getContext('2d')
                        self.contextTrans=drawImage(self.imageTrans,0,0)
                        self.dataTrans=self.contextTrans.getImageData(0,0,self.canvasTrans.width,self.canvasTrans.height)
                        self.dataResult=self.contextMap.createImageData(self.canvasMap.width,self.canvasMap.height)
                        for(let y = 0, offset = 0; y < self.imageMap.height; y++){
                            for(let x = 0; x < self.imageMap.width; x++, offset += 4){
                                self.dataResult.data[offset+0]	= self.dataMap.data[offset+0]
                                self.dataResult.data[offset+1]	= self.dataMap.data[offset+1]
                                self.dataResult.data[offset+2]	= self.dataMap.data[offset+2]
                                self.dataResult.data[offset+3]	= 255 - self.dataTrans.data[offset+0]
                            }
                        }
                        self.contextResult.putImageData(self.dataResult,0,0)
                        self.material.map.needsUpdate=true;
                    })
                    self.imageTrans.src='images/earthcloudmaptrans.jpg'
                },false)
                self.imageMap='images/earthcloudmap.jpg'

                self.texture=new THREE.Texture(self.canvasResult)
                self.sidey=THREE.DoubleSide
                self.transparenty=true
                self.opacitie=0.8
                self.draw()
                self.update()
            }
            
        }

        class Mars extends Planet{
            constructor(mass,x,y,z,vx,vy,vz){
                super(mass,x,y,z,vx,vy,vz)
                this.texture=THREE.ImageUtils.loadTexture('images/marsmap1k.jpg')
                self.bump=THREE.ImageUtils.loadTexture('images/marsbump1k.jpg')
                this.bumpscale=0.05
                this.draw()
                this.update()
            }
        }

        class Jupiter extends Planet{
            constructor(mass,x,y,z,vx,vy,vz){
                super(mass,x,y,z,vx,vy,vz)
                this.texture=THREE.ImageUtils.loadTexture('images/jupitermap.jpg')
                this.bumpmap=this.texture
                this.bumpscale=0.02
                this.draw()
                this.update()
            }
        }

        class Saturn extends Planet{

        }

        class Uranus extends Planet{

        }

        class Neptune extends Planet{
            constructor(mass,x,y,z,vx,vy,vz){
                this.texture=THREE.ImageUtils.loadTexture('images/mercurymap.jpg')
                this.bump=THREE.ImageUtils.loadTexture('images/mercurybump.jpg')
                this.bumpscale=0.005
                this.draw()
                this.update()
            }
        }

        class Pluto extends Planet{
            constructor(mass,x,y,z,vx,vy,vz){
                super(mass,x,y,z,vx,vy,vz)
                this.texture=THREE.ImageUtils.loadTexture('images/mercurymap.jpg')
                this.bump=THREE.ImageUtils.loadTexture('images/mercurybump.jpg')
                this.bumpscale=0.005
                this.draw()
                this.update()
            }
        }

        class Atmosphere extends Planet{
            constructor(mass,x,y,z,vx,vy,vz){
                super(mass,x,y,z,vx,vy,vz)
                let vertexShader	= [
                'varying vec3	vVertexWorldPosition;',
                'varying vec3	vVertexNormal;',

                'void main(){',
                '	vVertexNormal	= normalize(normalMatrix * normal);',

                '	vVertexWorldPosition	= (modelMatrix * vec4(position, 1.0)).xyz;',

                '	// set gl_Position',
                '	gl_Position	= projectionMatrix * modelViewMatrix * vec4(position, 1.0);',
                '}',

                ].join('\n')
                let fragmentShader	= [
                'uniform vec3	glowColor;',
                'uniform float	coeficient;',
                'uniform float	power;',

                'varying vec3	vVertexNormal;',
                'varying vec3	vVertexWorldPosition;',

                'void main(){',
                '	vec3 worldCameraToVertex= vVertexWorldPosition - cameraPosition;',
                '	vec3 viewCameraToVertex	= (viewMatrix * vec4(worldCameraToVertex, 0.0)).xyz;',
                '	viewCameraToVertex	= normalize(viewCameraToVertex);',
                '	float intensity		= pow(coeficient + dot(vVertexNormal, viewCameraToVertex), power);',
                '	gl_FragColor		= vec4(glowColor, intensity);',
                '}',
            ].join('\n')

            // create custom material from the shader code above
            //   that is within specially labeled script tags
            let material	= new THREE.ShaderMaterial({
                uniforms: { 
                    coeficient	: {
                        type	: "f", 
                        value	: 1.0
                    },
                    power		: {
                        type	: "f",
                        value	: 2
                    },
                    glowColor	: {
                        type	: "c",
                        value	: new THREE.Color('pink')
                    },
                },
                vertexShader	: vertexShader,
                fragmentShader	: fragmentShader,
                //blending	: THREE.AdditiveBlending,
                transparent	: true,
                depthWrite	: false,
            });
            
            }

            getMesh(){
                return material
            }
        }

        class starField{
            constructor(){
                this.texture	= THREE.ImageUtils.loadTexture('images/galaxy_starfield.png')
                this.material	= new THREE.MeshBasicMaterial({
                    map	: this.texture,
                    side	: THREE.BackSide
                })
                this.geometry	= new THREE.SphereGeometry(100, 32, 32)
                this.mesh	= new THREE.Mesh(this.geometry,this.material)
            }

            getMesh(){
                return this.mesh
            }

        }

        class Andromeda{
            constructor(){
                this.renderer = new THREE.WebGLRenderer({
                    antialias:true
                })
                this.renderer.setSize( window.innerWidth, window.innerHeight );

                this.scene = new THREE.Scene()
                this.camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 1, 1000 )
                this.axes = new THREE.AxesHelper( 1000 );
                this.scene.add( this.axes )
                this.light	= new THREE.AmbientLight( 0x888888 )
                this.scene.add( this.light )
                this.light	= new THREE.DirectionalLight( 0xcccccc, 1 )
                this.light.position.set(0,0,0)
                this.scene.add( this.light )
                this.light.castShadow	= true
                this.light.shadowCameraNear	= 0.01
                this.light.shadowCameraFar	= 15
                this.light.shadowCameraFov	= 45

                this.light.shadowCameraLeft	= -1
                this.light.shadowCameraRight	=  1
                this.light.shadowCameraTop	=  1
                this.light.shadowCameraBottom= -1
                this.camera.lookAt(0,0,0)
                this.camera.position.z=-5

                this.light.shadowBias	= 0.001
                this.light.shadowDarkness	= 0.2

                this.light.shadowMapWidth	= 1024*2
                this.light.shadowMapHeight	= 1024*2

                this.addPlanet()

                let self = this

                self.vector = {x:0,y:0}

                document.addEventListener('mousemove', function(event){
                    self.vector.x	= (event.clientX/window.innerWidth ) - 0.1
                    self.vector.y	= (event.clientY/window.innerHeight) - 0.1
                }, false)

                allupdate.push(function(delta, now){
                    self.camera.position.x += (self.vector.x*10 - (self.camera.position.x)) * (delta*3)
                    self.camera.position.y += (self.vector.y*10 - self.camera.position.y) * (delta*3)
                    self.camera.lookAt(0,0,0)
                    return delta;
                })

                allupdate.push(function(){
                    self.renderer.render( self.scene, self.camera );
                })


                let lastTimeMsec= null
                requestAnimationFrame(function animate(nowMsec){
                    requestAnimationFrame( animate );

                    lastTimeMsec	= lastTimeMsec || nowMsec-1000/60
                    let deltaMsec	= Math.min(200, nowMsec - lastTimeMsec)
                    lastTimeMsec	= nowMsec

                    allupdate.forEach(function(updateFn){
                        updateFn(deltaMsec/1000, nowMsec/1000)
                    })
                })

            }
            
            addtoPage(){
                document.body.appendChild(this.renderer.domElement)
            }

            add(mesh, delta, update){
                let world = mesh.getMesh()
                let self = this
                self.scene.add(mesh.getMesh());
                console.log(allx)
                console.log(ally)
                console.log(allz)
                console.log(allmass)
                console.log(allplanets)
            }

            addPlanet(){
                let self = this;
                let modal = document.getElementById('myModal');
                let btn = document.getElementById('myBtn');
                let newPlanet = document.getElementById('newPlan')
                let span = document.getElementsByClassName('close')[0];
               
                newMod.onclick = function() {
                    let massPlanet = parseFloat(document.getElementById('massvalue').value);
                    let xPlanet = parseFloat(document.getElementById('xpos').value);
                    let yPlanet = parseFloat(document.getElementById('ypos').value);
                    let zPlanet = parseFloat(document.getElementById('zpos').value);
                    let vxPlanet = parseFloat(document.getElementById('vxval').value);
                    let vyPlanet = parseFloat(document.getElementById('vyval').value);
                    let vzPlanet = parseFloat(document.getElementById('vzval').value)
                    

                    document.getElementById('selectpreset').onchange = function(){
                        console.log('hey')
                    }

                    self.add(new Mars(massPlanet,xPlanet,yPlanet,zPlanet,vxPlanet,vyPlanet,vzPlanet))
                    }
                
                btn.onclick = function() {
                    modal.style.display = 'block';
                    }
                
                span.onclick = function() {
                    modal.style.display = 'none';
                    }

                window.onclick = function(event) {
                    if (event.target == modal) {
                        modal.style.display = 'none';
                    }
                }
            }
        }


        let simStart = new Andromeda()
        simStart.addtoPage()
        simStart.add(new starField())
        simStart.add(new Star(10,0,0,0,0,0,0,0))
        simStart.add(new Earth(10,-5,1,0,0.001,0.001,0.03))
        
        /*
        setInterval(function(){
            console.log(planetx)
            console.log(planety)
            console.log(planetz)
            console.log(planetvx)
            console.log(planetvy)
            console.log(planetvz)
        }, 1000);
        */



    </script>

</body>